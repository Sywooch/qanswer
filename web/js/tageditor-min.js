function bindTagFilterAutoComplete(e,d){d=iAsk.options.site.baseUrl;var c=(d||"")+"/filter/tags";$(e).autocomplete(c,{max:6,dataType:"jsonp",matchSubset:false,highlightItem:true,multiple:true,multipleSeparator:" ",matchContains:true,scroll:true,scrollHeight:300,formatItem:function(g){var b=g[0];var a=g[1];return b+" ("+a+")"},formatResult:function(a){var b=a[0];return b}})}function initTagPreview(j,n,m){var h=null;var k;var l=window.tagRenderer;if(!l){return}var i=function(){if(j.closest("body").length==0){clearInterval(k);return}var b;if(j.hasClass("edit-field-overlayed")){b=""}else{b=j.val()}if(b==h){return}h=b;var a=sanitizeAndSplitTags(b);if(a.length==0){n.slideUp(function(){n.empty()});return}n.empty();for(var c=0;c<a.length;c++){var d=a[c];l(d).appendTo(n);n.append("<span> </span>")}if(a.length>m){n.append("<span class='form-error'>a question cannot have more than "+m+" tags</span>")}if(!n.is(":visible")){n.slideDown(function(){$(".ac_results").css("top",j.offset().top+j[0].offsetHeight)})}};k=setInterval(i,500);j.keydown(function(a){if(k){clearInterval(k)}if(a.which==32||a.which==13){i()}k=setInterval(i,500)})}(function(b){b.fn.extend({autocomplete:function(a,e){var f=typeof a=="string";e=b.extend({},b.Autocompleter.defaults,{url:f?a:null,data:f?null:a,delay:f?b.Autocompleter.defaults.delay:10,max:e&&!e.scroll?10:150},e);e.highlight=e.highlight||function(c){return c};e.formatMatch=e.formatMatch||e.formatItem;return this.each(function(){new b.Autocompleter(this,e)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});b.Autocompleter=function(z,B){var A={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SPACE:32};var H=b(z).attr("autocomplete","off").addClass(B.inputClass);var E;var K="";var T=b.Autocompleter.Cache(B);var G=0;var O;var F={mouseDownOnSelect:false};var C=b.Autocompleter.Select(B,z,I,F);var J;H.bind("keydown.autocomplete",function(c){O=c.keyCode;switch(c.keyCode){case A.UP:c.preventDefault();if(C.visible()){C.prev()}else{P(0,true)}break;case A.DOWN:c.preventDefault();if(C.visible()){C.next()}else{P(0,true)}break;case A.PAGEUP:c.preventDefault();if(C.visible()){C.pageUp()}else{P(0,true)}break;case A.PAGEDOWN:c.preventDefault();if(C.visible()){C.pageDown()}else{P(0,true)}break;case B.multiple&&b.trim(B.multipleSeparator)==","&&A.COMMA:case A.TAB:case A.RETURN:if(I()){c.preventDefault();J=true;return false}break;case A.ESC:C.hide();break;case B.multiple&&B.multipleSeparator===" "&&A.SPACE:y();break;default:clearTimeout(E);E=setTimeout(P,B.delay);break}}).focus(function(){G++}).blur(function(){G=0;if(!F.mouseDownOnSelect){Q()}}).click(function(){if(G++>1&&!C.visible()){P(0,true)}}).bind("search",function(){var d=(arguments.length>1)?arguments[1]:null;function c(e,h){var g;if(h&&h.length){for(var f=0;f<h.length;f++){if(h[f].result.toLowerCase()==e.toLowerCase()){g=h[f];break}}}if(typeof d=="function"){d(g)}else{H.trigger("result",g&&[g.data,g.value])}}b.each(M(H.val()),function(e,f){D(f,c,c)})}).bind("flushCache",function(){T.flush()}).bind("setOptions",function(){b.extend(B,arguments[1]);if("data" in arguments[1]){T.populate()}}).bind("unautocomplete",function(){C.unbind();H.unbind();b(z.form).unbind(".autocomplete")});function I(){var d=C.selected();if(!d){return false}var i=d.result;K=i;if(B.multiple){var c=M(H.val());if(c.length>1){var j=B.multipleSeparator.length;var k=b(z).selection().start;var g,e=0;b.each(c,function(m,l){e+=l.length;if(k<=e){g=m;return false}e+=j});c[g]=i;i=c.join(B.multipleSeparator)}i+=B.multipleSeparator}H.val(i);var h=H[0];if(h.createTextRange){var f=h.createTextRange();f.move("textedit");f.select()}y();H.trigger("result",[d.data,d.value]);return true}function P(e,c){if(O==A.DEL){C.hide();return}var d=H.val();if(!c&&d==K){return}K=d;d=R(d);if(d.length>=B.minChars){H.addClass(B.loadingClass);if(!B.matchCase){d=d.toLowerCase()}D(d,L,y)}else{N();C.hide()}}function M(e){if(!e){return[""]}var d=e.split(B.multipleSeparator);var c=[];b.each(d,function(g,f){if(b.trim(f)){c.push(b.trim(f))}});return c.length?c:[""]}function R(e){if(!B.multiple){return e}var d=M(e);if(d.length==1){return d[0]}var c=b(z).selection().start;if(c==e.length){d=M(e)}else{d=M(e.replace(e.substring(c),""))}return d[d.length-1]}function a(c,d){if(B.autoFill&&(R(H.val()).toLowerCase()==c.toLowerCase())&&O!=A.BACKSPACE){H.val(H.val()+d.substring(R(K).length));b(z).selection(K.length,K.length+d.length)}}function Q(){clearTimeout(E);E=setTimeout(y,200)}function y(){var c=C.visible();C.hide();clearTimeout(E);N();if(B.mustMatch){H.search(function(e){if(!e){if(B.multiple){var d=M(H.val()).slice(0,-1);H.val(d.join(B.multipleSeparator)+(d.length?B.multipleSeparator:""))}else{H.val("")}}})}}function L(c,d){if(d&&d.length&&G){N();C.display(d,c);a(c,d[0].value);C.show()}else{y()}}function D(c,h,d){if(!B.matchCase){c=c.toLowerCase()}var f=T.load(c);if(f&&f.length){h(c,f)}else{if((typeof B.url=="string")&&(B.url.length>0)){var e={timestamp:+new Date()};b.each(B.extraParams,function(j,i){e[j]=typeof i=="function"?i():i});var g=false;b.ajax({mode:"abort",port:"autocomplete"+z.name,dataType:B.dataType,url:B.url,data:b.extend({q:R(c),limit:B.max},e),success:function(j){var i=B.parse&&B.parse(j)||S(j);T.add(c,i);h(c,i);g=true},complete:function(){if(!g){h()}g=true}})}else{C.emptyList();d(c)}}}function S(e){var g=[];var d=e.split("\n");for(var c=0;c<d.length;c++){var f=b.trim(d[c]);if(f){f=f.split("|");g[g.length]={data:f,value:f[0],result:B.formatResult&&B.formatResult(f,f[0])||f[0]}}}return g}function N(){H.removeClass(B.loadingClass)}};b.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(a){return a[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(d,a){return d.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+a.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};b.Autocompleter.Cache=function(n){var a={};var j=0;function m(d,c){if(!n.matchCase){d=d.toLowerCase()}var e=d.indexOf(c);if(n.matchContains=="word"){e=d.toLowerCase().search("\\b"+c.toLowerCase())}if(e==-1){return false}return e==0||n.matchContains}function k(c,d){if(j>n.cacheLength){i()}if(!a[c]){j++}a[c]=d}function l(){if(!n.data){return false}var r={},h=0;if(!n.url){n.cacheLength=1}r[""]=[];for(var e=0,s=n.data.length;e<s;e++){var d=n.data[e];d=(typeof d=="string")?[d]:d;var f=n.formatMatch(d,e+1,n.data.length);if(f===false){continue}var c=f.charAt(0).toLowerCase();if(!r[c]){r[c]=[]}var g={value:f,data:d,result:n.formatResult&&n.formatResult(d)||f};r[c].push(g);if(h++<n.max){r[""].push(g)}}b.each(r,function(p,o){n.cacheLength++;k(p,o)})}setTimeout(l,25);function i(){a={};j=0}return{flush:i,add:k,populate:l,load:function(e){if(!n.cacheLength||!j){return null}if(!n.url&&n.matchContains){var f=[];for(var c in a){if(c.length>0){var g=a[c];b.each(g,function(h,o){if(m(o.value,e)){f.push(o)}})}}return f}else{if(a[e]){return a[e]}else{if(n.matchSubset){for(var d=e.length-1;d>=n.minChars;d--){var g=a[e.substr(0,d)];if(g){var f=[];b.each(g,function(h,o){if(m(o.value,e)){f[f.length]=o}});return f}}}}}return null}}};b.Autocompleter.Select=function(v,u,w,z){var G={ACTIVE:"ac_over"};var C,A=-1,J,E="",y=true,F,x;function B(){if(!y){return}F=b("<div/>").hide().addClass(v.resultsClass).css("position","absolute").appendTo(document.body);x=b("<ul/>").appendTo(F).mouseover(function(c){if(t(c).nodeName&&t(c).nodeName.toUpperCase()=="LI"){A=b("li",x).removeClass(G.ACTIVE).index(t(c));b(t(c)).addClass(G.ACTIVE)}}).click(function(c){b(t(c)).addClass(G.ACTIVE);w();u.focus();return false}).mousedown(function(){z.mouseDownOnSelect=true}).mouseup(function(){z.mouseDownOnSelect=false});if(v.width>0){F.css("width",v.width)}y=false}function t(c){var d=c.target;while(d&&d.tagName!="LI"){d=d.parentNode}if(!d){return[]}return d}function H(d){C.slice(A,A+1).removeClass(G.ACTIVE);I(d);var e=C.slice(A,A+1).addClass(G.ACTIVE);if(v.scroll){var c=0;C.slice(0,A).each(function(){c+=this.offsetHeight});if((c+e[0].offsetHeight-x.scrollTop())>x[0].clientHeight){x.scrollTop(c+e[0].offsetHeight-x.innerHeight())}else{if(c<x.scrollTop()){x.scrollTop(c)}}}}function I(c){A+=c;if(A<0){A=C.size()-1}else{if(A>=C.size()){A=0}}}function a(c){return v.max&&v.max<c?v.max:c}function D(){x.empty();var c=a(J.length);for(var f=0;f<c;f++){if(!J[f]){continue}var e=v.formatItem(J[f].data,f+1,c,J[f].value,E);if(e===false){continue}var d=b("<li/>").html(v.highlight(e,E)).addClass(f%2==0?"ac_even":"ac_odd").appendTo(x)[0];b.data(d,"ac_data",J[f])}C=x.find("li");if(v.selectFirst){C.slice(0,1).addClass(G.ACTIVE);A=0}}return{display:function(d,c){B();J=d;E=c;D()},next:function(){H(1)},prev:function(){H(-1)},pageUp:function(){if(A!=0&&A-8<0){H(-A)}else{H(-8)}},pageDown:function(){if(A!=C.size()-1&&A+8>C.size()){H(C.size()-1-A)}else{H(8)}},hide:function(){F&&F.hide();C&&C.removeClass(G.ACTIVE);A=-1},visible:function(){return F&&F.is(":visible")},current:function(){return this.visible()&&(C.filter("."+G.ACTIVE)[0]||v.selectFirst&&C[0])},show:function(){var c=b(u).offset();F.css({width:typeof v.width=="string"||v.width>0?v.width:b(u).width(),top:c.top+u.offsetHeight,left:c.left}).show();if(v.scroll){x.scrollTop(0);x.css({maxHeight:v.scrollHeight,overflow:"auto"});if(b.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var e=0;C.each(function(){e+=this.offsetHeight});var d=e>v.scrollHeight;x.css("height",d?v.scrollHeight:e);if(!d){C.width(x.width()-parseInt(C.css("padding-left"))-parseInt(C.css("padding-right")))}}}},selected:function(){var c=C&&C.filter("."+G.ACTIVE).removeClass(G.ACTIVE);return c&&c.length&&b.data(c[0],"ac_data")},emptyList:function(){x&&x.empty()},unbind:function(){F&&F.remove()}}};b.fn.selection=function(o,a){if(o!==undefined){return this.each(function(){if(this.createTextRange){var c=this.createTextRange();if(a===undefined||o==a){c.move("character",o);c.select()}else{c.collapse(true);c.moveStart("character",o);c.moveEnd("character",a);c.select()}}else{if(this.setSelectionRange){this.setSelectionRange(o,a)}else{if(this.selectionStart){this.selectionStart=o;this.selectionEnd=a}}}})}var m=this[0];if(m.createTextRange){var n=document.selection.createRange(),p=m.value,k="<->",l=n.text.length;if(l===0){return{start:m.value.length,end:m.value.length}}n.text=k;var j=m.value.indexOf(k);m.value=p;this.selection(j,j+l);return{start:j,end:j+l}}else{if(m.selectionStart!==undefined){return{start:m.selectionStart,end:m.selectionEnd}}}}})(jQuery);
